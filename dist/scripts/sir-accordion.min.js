"use strict";angular.module("sir-accordion",[]).directive("sirAccordion",["$compile","$timeout",function(e,n){var o="";return{restrict:"A",scope:{collection:"=",config:"=?",data:"=?"},template:o,controller:["$scope",function(e){e.config={debug:"undefined"!=typeof e.config.debug?e.config.debug:!1,animDur:e.config.animDur>=0&&document.body.firstElementChild?e.config.animDur:0,expandFirst:"undefined"!=typeof e.config.expandFirst?e.config.expandFirst:!1,autoCollapse:"undefined"!=typeof e.config.autoCollapse?e.config.autoCollapse:!0,watchInternalChanges:"undefined"!=typeof e.config.watchInternalChanges?e.config.watchInternalChanges:!1,headerClass:e.config.headerClass||"",beforeHeader:e.config.beforeHeader||"",afterHeader:e.config.afterHeader||"",topContentClass:e.config.topContentClass||"",beforeTopContent:e.config.beforeTopContent||"",afterTopContent:e.config.afterTopContent||"",bottomContentClass:e.config.bottomContentClass||"",beforeBottomContent:e.config.beforeBottomContent||"",afterBottomContent:e.config.afterBottomContent||""}}],link:function(o,t,i){var a="";i.id&&(a=i.id);var l=o.config.animDur,c="",r="",d="",s="",f=[],u=[],g=!1,p="0",C="background: #0044CE; color: #fff",v=null;o.$watch("collection",function(){if(!angular.isArray(o.collection))return void t.html("No collection found");c="",r="",d="",s="",f=[],u=[],g=!1,p="0",s=m(o.collection,0,0,0),t.html(""),v&&(v.$destroy(),v=null),v=o.$new();var n=e(s)(v);t.append(n),h(),o.$emit("sacDoneLoading"),o.config.expandFirst&&S("1")},o.config.watchInternalChanges);var h=function(){for(var e=null,n=null,o=null,i=u.length-1;i>=0;i--)e=t[0].querySelector(".sac"+u[i]),n=e.firstElementChild?e.firstElementChild:e.firstChild,o=n.nextSibling,u[i]={id:e.className,obj:o},f[i]={id:e.className,obj:n},e.firstElementChild&&(f[i].obj.style.transition="all "+l+"ms")},m=function(e,n,t,i){if(t==e.length)return"";d=i?String(n)+"-"+String(t+1):String(t+1);var a=d;c=o.config.beforeHeader+e[t].title+o.config.afterHeader,u.push(d);var l="";return angular.isArray(e[t].subCollection)&&e[t].subCollection.length||(l="sir-accordion-leaf"),r='<div class="sac'+d+'" ><div class="sir-accordion-header '+o.config.headerClass+'" ng-click="expandCollapseProgrammatically(\''+d+'\')"><div class="sir-accordion-vertical-align">'+c+'</div></div><div class="sir-accordion-content '+l+'"><div><div class="'+o.config.topContentClass+'">'+b(o.config.beforeTopContent,e[t].topContent,o.config.afterTopContent,"sac-top-"+a)+"</div>",0==t&&(r=0==i?'<div class="sir-accordion-wrapper">'+r:'<div class="sir-accordion-group">'+r),angular.isArray(e[t].subCollection)&&e[t].subCollection.length?(r+=m(e[t].subCollection,d,0,i+1),r=r+'</div><div class="'+o.config.bottomContentClass+'">'+b(o.config.beforeBottomContent,e[t].bottomContent,o.config.afterBottomContent,"sac-bottom-"+a)+"</div></div></div></div>"):r=r+'<div class="'+o.config.bottomContentClass+'">'+b(o.config.beforeBottomContent,e[t].bottomContent,o.config.afterBottomContent,"sac-bottom-"+a)+"</div></div></div></div>",r+m(e,n,t+1,i)},b=function(e,n,o,t){return n||(n=""),t?e+'<div id="'+a+t+'">'+n+"</div>"+o:e+"<div>"+n+"</div>"+o},x=function(e,n){if(o.config.debug&&console.log("Chain collapsing"),!(y(e)<=n))do{for(var t=u.length-1;t>=0;t--)o.config.autoCollapse&&u[t].id=="sac"+e?(E(u[t],"expanded"),E(f[t],"active-header")):j(u[t].id)==j(e)&&u[t].obj.className.indexOf("expanded")>-1&&(E(u[t],"expanded"),E(f[t],"active-header"));e=j(e)}while(y(e)!=n)},y=function(e){return"0"==e?0:e.split("-").length},j=function(e){if(-1==e.indexOf("-"))return"0";var n="";do n=e.substr(e.length-1),e=e.slice(0,-1);while("-"!=n);return e=e.replace("sac","")},E=function(e,n){var t=null;return e.obj.className.indexOf(n)>-1?(e.obj.className=e.obj.className.replace(n,""),o.config.debug&&console.log("removing class "+e.id),"expanded"==n&&(t=e.obj.firstElementChild?e.obj.firstElementChild:e.obj.firstChild,N(t,"finish"),N(t,"slideUp",{display:null,duration:l,complete:function(){t.style.height="0px";var n=e.id.replace("sac","");y(p)===y(n)-1&&o.$emit("sacCollapseEnd",n)}})),!0):(e.obj.className=B(e.obj.className)+" "+n,o.config.debug&&console.log("adding class "+e.id),"expanded"==n&&(t=e.obj.firstElementChild?e.obj.firstElementChild:e.obj.firstChild,N(t,"finish"),N(t,"slideDown",{delay:0,duration:l,progress:function(){e.obj.style.height="auto"},begin:function(){e.obj.style.height="0px",t.style.height="auto"},complete:function(){e.id.replace("sac","")===p&&o.$emit("sacExpandEnd",p)}})),!0)},N=function(e,n,o){return"undefined"==typeof Velocity?void(o?$(e).velocity(n,o):$(e).velocity(n)):void(o?Velocity(e,n,o):Velocity(e,n))},w=function(e,n){do{if(j(n)==e)return!0;n=j(n)}while(y(n)>y(e));return!1},B=function(e){for(var e=e.replace(/^\s\s*/,""),n=/\s/,o=e.length;n.test(e.charAt(--o)););return e.slice(0,o+1)},O=function(e){for(var n=u.length-1;n>=0;n--)if(u[n].id=="sac"+e||u[n].id==e)return n;return-1},A=function(e,n){for(var o=e.length-1;o>=0;o--)w(n,e[o].id)&&e[o].obj.className.indexOf("expanded")>-1&&(E(e[o],"expanded"),E(f[o],"active-header"))},S=function(e){if("0"==e)return I(),void(p="0");if(e!=p){if(w(e,p))return x(p,y(e)),void(p=e);var n=e.split("-"),t=p.split("-"),i="",a=0,l=0,c=0;if(o.config.autoCollapse&&"0"!=p){for(var r=0;r<n.length||r<t.length;r++)n[r]!=t[r]||c?c++:l++;if(c>1&&l<y(e))for(var d=t.length-l,s=p;d>0;)E(u[O(s)],"expanded"),E(f[O(s)],"active-header"),s=j(s),d--;else x(p,y(e)-1)}for(var r=0;r<n.length;r++){for(var g=0;r>=g;g++)i=g?i+"-"+n[g]:n[g];u[O(i)]?-1==u[O(i)].obj.className.indexOf("expanded")?(H(u[O(i)],f[O(i)],a),r===n.length-1&&o.$emit("sacExpandStart",i),p=i):a--:o.config.debug&&console.log("%c Coordinate does not match an element",C),i=""}}};o.expandCollapseProgrammatically=function(e){g||(-1!=u[O(e)].obj.className.indexOf("expanded")?D(e):S(e))};var D=function(e){-1!=u[O(e)].obj.className.indexOf("expanded")&&(A(u,e),E(u[O(e)],"expanded"),E(f[O(e)],"active-header"),console.log("sacCollapseStart "+p),o.$emit("sacCollapseStart",p),p=j(e))},H=function(e,o,t){n(function(){E(e,"expanded"),E(o,"active-header")},l*(y(e.id)-1+t))},I=function(){p="0";for(var e=u.length-1;e>=0;e--)u[e].obj.className.indexOf("expanded")>-1&&(E(u[e],"expanded"),E(f[e],"active-header"))};o.$on("sacCollapseAll",function(e){I(),e.defaultPrevented=!0}),o.$on("sacExpandAll",function(e,n){if(!o.config.autoCollapse)for(var t=0;t<=u.length-1;t++)-1==u[t].obj.className.indexOf("expanded")&&H(u[t],f[t],0);e.defaultPrevented=!0}),o.$on("sacExpandContentById",function(e,n){S(n),e.defaultPrevented=!0}),o.$on("sacCollapseContentById",function(e,n){D(n),e.defaultPrevented=!0})}}}]);