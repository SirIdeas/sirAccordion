"use strict";angular.module("sir-accordion",[]).directive("sirAccordion",["$compile","$timeout",function(a,b){var c="";return{restrict:"A",scope:{collection:"=",config:"=?",data:"=?"},template:c,controller:["$scope",function(a){a.config={debug:"undefined"!=typeof a.config.debug&&a.config.debug,animDur:a.config.animDur>=0&&document.body.firstElementChild?a.config.animDur:0,expandFirst:"undefined"!=typeof a.config.expandFirst&&a.config.expandFirst,autoCollapse:"undefined"==typeof a.config.autoCollapse||a.config.autoCollapse,watchInternalChanges:"undefined"!=typeof a.config.watchInternalChanges&&a.config.watchInternalChanges,headerClass:a.config.headerClass||"",beforeHeader:a.config.beforeHeader||'<div class="sir-accordion-vertical-align"><div>',afterHeader:a.config.afterHeader||"</div></div>",topContentClass:a.config.topContentClass||"",beforeTopContent:a.config.beforeTopContent||"",afterTopContent:a.config.afterTopContent||"",bottomContentClass:a.config.bottomContentClass||"",beforeBottomContent:a.config.beforeBottomContent||"",afterBottomContent:a.config.afterBottomContent||""}}],link:function(c,d){var e=c.config.animDur,f="",g="",h="",i="",j=[],k=[],l=!1,m="0",n="background: #0044CE; color: #fff",o=null;c.$watch("collection",function(){if(!angular.isArray(c.collection))return void d.html("No collection found");f="",g="",h="",i="",j=[],k=[],l=!1,m="0",i=q(c.collection,0,0,0),d.html(""),o&&(o.$destroy(),o=null),o=c.$new();var b=a(i)(o);d.append(b),p(),c.$emit("sacDoneLoading"),c.config.expandFirst&&B("1")},c.config.watchInternalChanges);var p=function(){for(var a=null,b=null,c=null,f=k.length-1;f>=0;f--)a=d[0].querySelector(".sac"+k[f]),b=a.firstElementChild?a.firstElementChild:a.firstChild,c=b.nextSibling,k[f]={id:a.className,obj:c},j[f]={id:a.className,obj:b},a.firstElementChild&&(j[f].obj.style.transition="all "+e+"ms")},q=function(a,b,d,e){if(d==a.length)return"";h=e?String(b)+"-"+String(d+1):String(d+1),f=c.config.beforeHeader+a[d].title+c.config.afterHeader,k.push(h);var i="";return angular.isArray(a[d].subCollection)&&a[d].subCollection.length||(i="sir-accordion-leaf"),g='<div class="sac'+h+'" ><div class="sir-accordion-header '+c.config.headerClass+'" ng-click="expandCollapseProgrammatically(\''+h+"')\">"+f+'</div><div class="sir-accordion-content '+i+'"><div><div class="'+c.config.topContentClass+'">'+r(c.config.beforeTopContent,a[d].topContent,c.config.afterTopContent)+"</div>",0==d&&(g=0==e?'<div class="sir-accordion-wrapper">'+g:'<div class="sir-accordion-group">'+g),angular.isArray(a[d].subCollection)&&a[d].subCollection.length?(g+=q(a[d].subCollection,h,0,e+1),g=g+'</div><div class="'+c.config.bottomContentClass+'">'+r(c.config.beforeBottomContent,a[d].bottomContent,c.config.afterBottomContent)+"</div></div></div></div>"):g=g+'<div class="'+c.config.bottomContentClass+'">'+r(c.config.beforeBottomContent,a[d].bottomContent,c.config.afterBottomContent)+"</div></div></div></div>",g+q(a,b,d+1,e)},r=function(a,b,c){return b=b?a+b+c:""},s=function(a,b){if(c.config.debug&&console.log("Chain collapsing"),!(t(a)<=b))do{for(var d=k.length-1;d>=0;d--)c.config.autoCollapse&&k[d].id=="sac"+a?(v(k[d],"expanded"),v(j[d],"active-header")):u(k[d].id)==u(a)&&k[d].obj.className.indexOf("expanded")>-1&&(v(k[d],"expanded"),v(j[d],"active-header"));a=u(a)}while(t(a)!=b)},t=function(a){return"0"==a?0:a.split("-").length},u=function(a){if(a.indexOf("-")==-1)return"0";var b="";do b=a.substr(a.length-1),a=a.slice(0,-1);while("-"!=b);return a=a.replace("sac","")},v=function(a,b){var d=null;return a.obj.className.indexOf(b)>-1?(a.obj.className=a.obj.className.replace(b,""),c.config.debug&&console.log("removing class "+a.id),"expanded"==b&&(d=a.obj.firstElementChild?a.obj.firstElementChild:a.obj.firstChild,w(d,"finish"),w(d,"slideUp",{display:null,duration:e,complete:function(){d.style.height="0px"}})),!0):(a.obj.className=y(a.obj.className)+" "+b,c.config.debug&&console.log("adding class "+a.id),"expanded"==b&&(d=a.obj.firstElementChild?a.obj.firstElementChild:a.obj.firstChild,w(d,"finish"),w(d,"slideDown",{delay:0,duration:e,progress:function(){a.obj.style.height="auto"},begin:function(){a.obj.style.height="0px",d.style.height="auto"}})),!0)},w=function(a,b,c){return"undefined"==typeof Velocity?void(c?$(a).velocity(b,c):$(a).velocity(b)):void(c?Velocity(a,b,c):Velocity(a,b))},x=function(a,b){do{if(u(b)==a)return!0;b=u(b)}while(t(b)>t(a));return!1},y=function(a){for(var a=a.replace(/^\s\s*/,""),b=/\s/,c=a.length;b.test(a.charAt(--c)););return a.slice(0,c+1)},z=function(a){for(var b=k.length-1;b>=0;b--)if(k[b].id=="sac"+a||k[b].id==a)return b;return-1},A=function(a,b){for(var c=a.length-1;c>=0;c--)x(b,a[c].id)&&a[c].obj.className.indexOf("expanded")>-1&&(v(a[c],"expanded"),v(j[c],"active-header"))},B=function(a){if("0"==a)return E(),void(m="0");if(a!=m){if(x(a,m))return s(m,t(a)),void(m=a);var b=a.split("-"),d=m.split("-"),e="",f=0,g=0,h=0;if(c.config.autoCollapse&&"0"!=m){for(var i=0;i<b.length||i<d.length;i++)b[i]!=d[i]||h?h++:g++;if(h>1&&g<t(a))for(var l=d.length-g,o=m;l>0;)v(k[z(o)],"expanded"),v(j[z(o)],"active-header"),o=u(o),l--;else s(m,t(a)-1)}for(var i=0;i<b.length;i++){for(var p=0;p<=i;p++)e=p?e+"-"+b[p]:b[p];k[z(e)]?k[z(e)].obj.className.indexOf("expanded")==-1?(D(k[z(e)],j[z(e)],f),m=e):f--:c.config.debug&&console.log("%c Coordinate does not match an element",n),e=""}}};c.expandCollapseProgrammatically=function(a){l||(k[z(a)].obj.className.indexOf("expanded")!=-1?C(a):B(a))};var C=function(a){k[z(a)].obj.className.indexOf("expanded")!=-1&&(A(k,a),v(k[z(a)],"expanded"),v(j[z(a)],"active-header"),m=u(a))},D=function(a,c,d){b(function(){v(a,"expanded"),v(c,"active-header")},e*(t(a.id)-1+d))},E=function(){m="0";for(var a=k.length-1;a>=0;a--)k[a].obj.className.indexOf("expanded")>-1&&(v(k[a],"expanded"),v(j[a],"active-header"))};c.$on("sacCollapseAll",function(a){E(),a.defaultPrevented=!0}),c.$on("sacExpandAll",function(a,b){if(!c.config.autoCollapse)for(var d=0;d<=k.length-1;d++)k[d].obj.className.indexOf("expanded")==-1&&D(k[d],j[d],0);a.defaultPrevented=!0}),c.$on("sacExpandContentById",function(a,b){B(b),a.defaultPrevented=!0}),c.$on("sacCollapseContentById",function(a,b){C(b),a.defaultPrevented=!0})}}}]);